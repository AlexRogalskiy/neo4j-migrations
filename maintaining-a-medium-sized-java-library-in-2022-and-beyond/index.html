<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<meta name="author" content="Michael Simons">
<title>Maintaining a medium-sized Java library in 2022 and beyond</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:50%;border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid currentColor;opacity:.35;padding:0 .5em 0 0}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="book">
<div id="header">
<h1>Maintaining a medium-sized Java library in 2022 and beyond</h1>
<div class="details">
<span id="author" class="author">Michael Simons</span><br>
<span id="email" class="email"><a href="mailto:michael.simons@neo4j.com">michael.simons@neo4j.com</a></span><br>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#preface-introduction">Preface and introduction</a>
<ul class="sectlevel2">
<li><a href="#_whats_the_size_of_the_project">What&#8217;s the size of the project?</a></li>
</ul>
</li>
<li><a href="#which-java">1. Which Java version to pick in early 2020?</a>
<ul class="sectlevel2">
<li><a href="#_use_the_current_lts_version_or_the_most_widely_adopted_one">1.1. Use the current LTS version or the most widely adopted one?</a></li>
<li><a href="#_caveats_and_how_to_address_them">1.2. Caveats and how to address them</a>
<ul class="sectlevel3">
<li><a href="#_dont_rely_on_a_derived_automatic_module_name">1.2.1. Don&#8217;t rely on a derived automatic module name</a></li>
<li><a href="#_use_the_latest_and_greatest_jdk">1.2.2. Use the latest and greatest JDK</a></li>
<li><a href="#_learn_about_multi_release_jars">1.2.3. Learn about Multi-Release Jars</a></li>
<li><a href="#_what_about_jdk_9_dependencies">1.2.4. What about JDK 9+ dependencies?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#building-things">2. Building things</a>
<ul class="sectlevel2">
<li><a href="#_welcome_to_burning_geek_con_the_choice_of_a_build_tool">2.1. Welcome to Burning Geek Con: The choice of a build tool</a>
<ul class="sectlevel3">
<li><a href="#_why_not_gradle">2.1.1. Why not Gradle?</a></li>
<li><a href="#_why_not_bazel">2.1.2. Why not Bazel?</a></li>
<li><a href="#_why_not_bach">2.1.3. Why not Bach?</a></li>
<li><a href="#_maven_it_is">2.1.4. Maven it is</a></li>
</ul>
</li>
<li><a href="#_my_maven_best_practices">2.2. My Maven best practices</a>
<ul class="sectlevel3">
<li><a href="#_use_properties_and_dependency_management_for_versions">2.2.1. Use properties and dependency management for versions</a></li>
<li><a href="#_make_use_of_the_enforcer_plugin">2.2.2. Make use of the enforcer plugin</a></li>
<li><a href="#_more_conventions">2.2.3. More conventions</a></li>
<li><a href="#_escalate_away_from_conventions">2.2.4. Escalate away from conventions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Frameworks">3. Frameworks</a>
<ul class="sectlevel2">
<li><a href="#general-considerations">3.1. General considerations</a></li>
<li><a href="#_spring_boot">3.2. Spring Boot</a></li>
<li><a href="#_quarkus">3.3. Quarkus</a>
<ul class="sectlevel3">
<li><a href="#_creating_a_closed_world_at_build_time">3.3.1. Creating a closed world at build time</a></li>
<li><a href="#_project_setup_for_an_extension">3.3.2. Project setup for an extension</a></li>
<li><a href="#_the_effect_on_neo4j_migrations">3.3.3. The effect on Neo4j-Migrations</a></li>
<li><a href="#_quintessence">3.3.4. Quintessence</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#releasing-things">4. Releasing things</a>
<ul class="sectlevel2">
<li><a href="#_semantic_versioning">4.1. Semantic versioning</a></li>
<li><a href="#_release_tooling">4.2. Release tooling</a></li>
</ul>
</li>
<li><a href="#_resources">Resources</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>&#169; Copyright 2022 Michael Simons.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="preface-introduction"><a class="anchor" href="#preface-introduction"></a>Preface and introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is a small ebook about maintaining a medium-sized Java project in 2022. The project in question Neo4j-Migrations
available at <a href="https://github.com/michael-simons/neo4j-migrations">github.com/michael-simons/neo4j-migrations</a>.
Things addressed in here are among others the choice of Java 8 as baseline, the build systems, build-plugins considered to be useful, recommendations about
structure but also concepts of certain libraries, GraalVM native and how to make things work with each other.</p>
</div>
<div class="paragraph">
<p>Neo4j-Migrations has been conceived in early 2020 and has developed from  basically one single Spring <code>InitializingBean</code>
with a couple of logic attached to it to a multi-module project with a core API integrated into several ecosystems.
The domain of that project is not too complex to understand: It&#8217;s goal is to run one or more migrations or database refactoring
against a Neo4j graph database instance in a reliable fashion, making sure each refactoring is applied only once. Those
migrations can come in to flavors: Either as script (a textfile containing Cypher code) or as a class runnable on the JVM.</p>
</div>
<div class="paragraph">
<p>This will give a couple of interesting things to discuss:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Which Java version to pick (taking into account it was 2020 when that decision was made)?</p>
<div class="ulist">
<ul>
<li>
<p>How to benefit from modern Java nevertheless?</p>
</li>
<li>
<p>How to prepare for or even embrace the Java module system?</p>
</li>
</ul>
</div>
</li>
<li>
<p>Which build tool did I chose and why?</p>
<div class="ulist">
<ul>
<li>
<p>What are my approaches to make the build as readable as possible?</p>
</li>
<li>
<p>How do I tackle programmatic tasks in the build in contrast to declarative ones</p>
</li>
<li>
<p>How to automate testing?</p>
</li>
<li>
<p>How to automate releasing and where to release?</p>
</li>
</ul>
</div>
</li>
<li>
<p>Can Java be good choice for CLI tooling?</p>
<div class="ulist">
<ul>
<li>
<p>What is possible with GraalVM native image and what isn&#8217;t?</p>
</li>
</ul>
</div>
</li>
<li>
<p>How to provide uniform access to this library in peoples favorite application frameworks?</p>
<div class="ulist">
<ul>
<li>
<p>Revisiting Spring Boot starter</p>
</li>
<li>
<p>Learning about Quarkus Extensions</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>This publication is of course highly subjective. Actually, like most books, posts and what have you out there: It works for me
and this project. It doesn&#8217;t work necessarily for your setup. Some things might even be harmful for your cases, probably
you find some of them utterly and outright stupid.</p>
</div>
<div class="sect2">
<h3 id="_whats_the_size_of_the_project"><a class="anchor" href="#_whats_the_size_of_the_project"></a>What&#8217;s the size of the project?</h3>
<div class="paragraph">
<p>"Sloc Cloc and Code" <a href="#scc">[scc]</a> gives me the following output for version <a href="https://github.com/michael-simons/neo4j-migrations/releases/tag/1.4.0">1.4.0</a>, along with some cost estimation based on the COCOMO <a href="#COCOMO">[COCOMO]</a> model:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">scc --exclude-dir docs/book
───────────────────────────────────────────────────────────────────────────────
Language                 Files     Lines   Blanks  Comments     Code Complexity
───────────────────────────────────────────────────────────────────────────────
Java                       153     14206     2186      4184     7836        330
XML                         29      3584      154       134     3296          0
AsciiDoc                     8      1562      344         0     1218          0
Properties File              7        37        3        13       21          0
Shell                        6       392       49        65      278         38
YAML                         5       294       28         0      266          0
Smarty Template              3        44        7         0       37          2
Groovy                       2        71        7        32       32          1
HTML                         2        71        5         0       66          0
JSON                         2        23        0         0       23          0
Markdown                     2       755      238         0      517          0
Plain Text                   2       219       33         0      186          0
Batch                        1       182       35         0      147         30
gitignore                    1        33        5         4       24          0
───────────────────────────────────────────────────────────────────────────────
Total                      223     21473     3094      4432    13947        401
───────────────────────────────────────────────────────────────────────────────
Estimated Cost to Develop (organic) $429,833
Estimated Schedule Effort (organic) 9.978566 months
Estimated People Required (organic) 3.826907
───────────────────────────────────────────────────────────────────────────────
Processed 732729 bytes, 0.733 megabytes (SI)
───────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
</div>
<div class="paragraph">
<p>The estimated schedule effort is actually not completely wrong.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="which-java"><a class="anchor" href="#which-java"></a>1. Which Java version to pick in early 2020?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Shiny new things are always neat, but not every target environment supports the latest bits and pieces
While an application that bring its own runtime, deployed in a container of its own or similar has a lot of freedom
to just pick the latest and greatest, a library may have not.</p>
</div>
<div class="sect2">
<h3 id="_use_the_current_lts_version_or_the_most_widely_adopted_one"><a class="anchor" href="#_use_the_current_lts_version_or_the_most_widely_adopted_one"></a>1.1. Use the current LTS version or the most widely adopted one?</h3>
<div class="paragraph">
<p>JDK 11 had been published as LTS-Version in September 2018. 11 incorporates most of the features from 9 and 10, with a couple
of things I think would have been useful to have in the core API of this project such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>actually and without joking, the module system</p>
</li>
<li>
<p>a way nicer <code>Optional</code> with methods such as <code>or</code>, <code>flatmap</code> and <code>ifPresentOrElse</code></p>
</li>
<li>
<p>finally, factory methods for collections</p>
</li>
<li>
<p>effective-final variables as resources in the try-with-resource statement (<code>var resource = new CypherResource(); try(resource) {}</code> or
coming in as a method argument)</p>
</li>
<li>
<p>some nice additions to the stream API (<code>dropWhile</code> and <code>takeWhile</code>)</p>
</li>
<li>
<p>the reserved type name <code>var</code> defined by <a href="#jep286">[jep286]</a> in a couple of places</p>
</li>
<li>
<p>the new <code>not</code>-predicate method</p>
</li>
<li>
<p>the Flight Recorder from <a href="#jep328">[jep328]</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As this project is intended as a library and incorporated into other peoples programs I am not that much interested in the
addition of new garbage collectors. If this had been an application, those additions would have had a much bigger influence.</p>
</div>
<div class="paragraph">
<p>Neo4j-Migrations is a library, however. I want as many people as possible to be able to use it in their applications if they
have the need for such a functionality. In 2020 JDK 8 was still the correct choice: It&#8217;s a given fact that enterprise users
are slow to migrate their runtime. Of course, it is valid to argue that a nudge might help them to migrate, but the reality
seems to be different.
And as a matter of fact, it&#8217;s not only enterprises. Or at least not only enterprises directly. One of the biggest drivers
of the Java ecosystem, the Spring Framework, still targets JDK 8. And so do value adding libraries on top of it, like Spring Data,
JHipster and many more: I wanted Neo4j-Migrations to benefit from that ecosystem without forcing users to bump their JDK
if they use my library.</p>
</div>
<div class="paragraph">
<p>So looking at the above list and seeing a couple of things that would have been nice to have in contrast to actual value, the
decision was made for <strong>JDK 8,</strong> and I am happy with it.</p>
</div>
<div class="paragraph">
<p>At the time of writing JDK 17, the current LTS, has been out for 4 months already. JDK 17 brings many more things to the table.
The most prominent features being text blocks, records, sealed classes and pattern matching. Those, together with the fact
that some runtimes like <a href="#Helidon">[Helidon]</a> and <a href="#Quarkus">[Quarkus]</a> already made the jump to 11 since 2020 and
<a href="#SpringFramework">Spring Framework</a> 6 will even have JDK 17 as baseline and has just dropped the first beta<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>
would have probably led to a different decision.</p>
</div>
</div>
<div class="sect2">
<h3 id="_caveats_and_how_to_address_them"><a class="anchor" href="#_caveats_and_how_to_address_them"></a>1.2. Caveats and how to address them</h3>
<div class="paragraph">
<p>The caveats with rooting for JDK 8 come in the form of a couple of "But what if…".</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What if it isn&#8217;t the worst idea to actually be prepared for <a href="#jep261">[jep261]</a>, the Java module system delivered in JDK 9
and used in JDK 17 via <a href="#jep396">[jep396]</a> to encapsulate JDK internals <strong>by default</strong></p>
</li>
<li>
<p>What if some features are so useful that I still want them? Like at least being able to put up bigger sign than just naming a
package <code>internal</code> to prevent people from using things they should not use because I plan to change them as I see fit?</p>
</li>
<li>
<p>What if I myself want to use a library that already made the jump beyond 8?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Those can be addressed by a couple of things:</p>
</div>
<div class="sect3">
<h4 id="_dont_rely_on_a_derived_automatic_module_name"><a class="anchor" href="#_dont_rely_on_a_derived_automatic_module_name"></a>1.2.1. Don&#8217;t rely on a derived automatic module name</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
What is an automatic Java module name? An automatic module name basically indicates the absence of a module
descriptor (<code>module-info.java</code>). If the JAR file containing the classes in question has the attribute "Automatic-Module-Name"
in its main manifest then its value is the module name. The module name is otherwise derived from the name of the JAR file.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>First and foremost, be a good citizen and define an automatic module name right from the start and don&#8217;t rely on a name
derived from your libraries JAR file.
This prevents that users  of your library that are running on JDK 9+ on the module path have to deal with a derived name
in their <code>module-info.java</code> when referring your library. Why would that be an issue? Because you will break them as soon
as you want to benefit from modules yourself in which you need to declare a non-automatic name which will most likely be different
from the one derived from the JAR file. Christian Stein has a couple of suggestions in <a href="#stein-maven-coordinates-and-module-names">[stein-maven-coordinates-and-module-names]</a>
I followed loosely when choosing the module names of Neo4j-Migrations and other current projects.</p>
</div>
</div>
<div class="sect3">
<h4 id="_use_the_latest_and_greatest_jdk"><a class="anchor" href="#_use_the_latest_and_greatest_jdk"></a>1.2.2. Use the latest and greatest JDK</h4>
<div class="paragraph">
<p>Use the latest and greatest JDK to compile and know about the <code>--release</code> flag available for
javac<sup class="footnote" id="_footnote_fn-javac-help">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup> since JDK 9. The <code>--release</code> flag is different
from <code>--source</code> and <code>--target</code>: In contrast to the combination of the latter, <code>--release</code> will not only make sure that the
<code>--target</code> matches the <code>--source</code> but also that only API is being used that  is available in the targeted release. In other
words: With <code>--source</code> and <code>--target</code> alone you would be able to compile Java 8 syntax into Java 8 byte code but still using
API only available in higher JDKs when not using JDK 8 itself. The release flag prevents this.</p>
</div>
</div>
<div class="sect3">
<h4 id="_learn_about_multi_release_jars"><a class="anchor" href="#_learn_about_multi_release_jars"></a>1.2.3. Learn about Multi-Release Jars</h4>
<div class="paragraph">
<p>Multi-Release Jars, defined in <a href="#jep238">[jep238]</a>, extend the JAR file format to allow multiple,
Java-release-specific versions of class files to coexist in a single archive. This allows for a couple of things:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You are not restricted to an automatic module name for your library targeting primarily Java 8. A valid <code>module-info.java</code>
can be part of the Jar for JDK 9+</p>
</li>
<li>
<p>In case you would benefit so much from new API that it is worth the effort of maintaining two versions of class, you can do that</p>
</li>
<li>
<p>One thing I did for JDK 17 was making use of sealed classes so that I can provide more guidance in the API which interfaces
I introduced only for the API itself and which one and through what hierarchy people are supposed to implement.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The downside to it is IDE support in my experience. I haven&#8217;t found a good way to work with the source structure of a Multi-Release Jar,
but I will write more about it in <a href="#building-things">Chapter 2</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_what_about_jdk_9_dependencies"><a class="anchor" href="#_what_about_jdk_9_dependencies"></a>1.2.4. What about JDK 9+ dependencies?</h4>
<div class="paragraph">
<p>This is a problem if you need such dependencies and still want to support JDK 8. The only solution here is not to have them.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="building-things"><a class="anchor" href="#building-things"></a>2. Building things</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this part the choice of the build tool, plugins for it and externalized programmatic additions will be discussed</p>
</div>
<div class="sect2">
<h3 id="_welcome_to_burning_geek_con_the_choice_of_a_build_tool"><a class="anchor" href="#_welcome_to_burning_geek_con_the_choice_of_a_build_tool"></a>2.1. Welcome to Burning Geek Con: The choice of a build tool</h3>
<div class="paragraph">
<p>We have suggested the <a href="https://info.michael-simons.eu/2016/08/17/burning-geek-insult-con/">"Insult Con"</a> back in 2016 already.
Choosing a build tool is probably worth a whole track alone.
Let&#8217;s discuss the options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://maven.apache.org">Maven</a></p>
</li>
<li>
<p><a href="https://gradle.org">Gradle</a></p>
</li>
<li>
<p><a href="https://bazel.build">Bazel</a></p>
</li>
<li>
<p><a href="https://github.com/sormuras/bach">Bach</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We might add ant and a couple of others to it as well, plus every homegrown solution out there. Of course, a homegrown solution
can be totally fine as well. Neo4j-Migrations can be seen as homegrown, too of course. It solved one issue and evolved later.
Just because a thing is on GitHub it doesn&#8217;t mean it&#8217;s automatically better than what you would write inside your company.</p>
</div>
<div class="paragraph">
<p>To cut it short: I opted for good, old, boring Maven.
Why? Because I am not only familiar with it, but it&#8217;s boring in a positive way: If you don&#8217;t escalate in a pom file, most
projects look more or less the same and most of the time, they behave the same.</p>
</div>
<div class="sect3">
<h4 id="_why_not_gradle"><a class="anchor" href="#_why_not_gradle"></a>2.1.1. Why not Gradle?</h4>
<div class="paragraph">
<p>I never felt like I need the promoted flexibility it brings.
I don&#8217;t need the Groovy (or Kotlin) these days for the mast majority of tasks I have in my builds.
Also, I did observe several times that using newer versions of Java than the ones that have been latest when a specific version
of Gradle has been released, causes problems. This is because Gradle depends on <a href="#ASM">[ASM]</a>.
ASM is an all-purpose Java bytecode manipulation and analysis framework. It can be used to modify existing classes or to
dynamically generate classes, directly in binary form. As such it is tailored to specific Java versions.</p>
</div>
<div class="paragraph">
<p>While this is not inherently a bad thing, I prefer not having to deal with it, especially as there wasn&#8217;t anything on the table
I couldn&#8217;t get from Maven.</p>
</div>
<div class="paragraph">
<p>Of course there is the valid argument of incremental builds: Gradle seems to be a lot better in that regard in contrast to Maven.
Also, there is the <a href="https://docs.gradle.com/enterprise/tutorials/caching/">build cache</a> who has done great things for Spring Boot
as reported back in 2020<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup>:</p>
</div>
<div class="quoteblock">
<blockquote>
The Spring Boot team&#8217;s primary reason for considering a switch to Gradle was to reduce the time that it takes to build the project. We were becoming frustrated with the length of the feedback loop when making and testing changes.
</blockquote>
<div class="attribution">
&#8212; Andy Wilkinson in "Migrating Spring Boot&#8217;s Build to Gradle"
</div>
</div>
<div class="paragraph">
<p>In this project here I would benefit much more in shaving more than just seconds from the lengthy restart time of the database
containers being used to verify migrations against.</p>
</div>
</div>
<div class="sect3">
<h4 id="_why_not_bazel"><a class="anchor" href="#_why_not_bazel"></a>2.1.2. Why not Bazel?</h4>
<div class="paragraph">
<p>Bazels focus seems to be a lot on incremental build, local or distributed caching. While it was intriguing to try out something
completely new, it would have added a steep learning curve for me and I was more focussed on solving a business usecase.</p>
</div>
</div>
<div class="sect3">
<h4 id="_why_not_bach"><a class="anchor" href="#_why_not_bach"></a>2.1.3. Why not Bach?</h4>
<div class="paragraph">
<p><a href="https://github.com/sormuras/bach">Bach</a> is an interesting contender in that regard that it uses Java and Java Modules to build
Java Modules.
I did work a bit with the author, Christian Stein, on it, and we migrated one other pet project of mine to use it.
I like the "Java only" approach a lot, and I think it has potential. However, it is Java Modules only. While I am gonna speak about
modules in this publication, Neo4j-Migrations is not only Java modules.</p>
</div>
<div class="paragraph">
<p>In addition, Bach is a lot of work in progress. Of course, this is not bad and someone has to solve the egg-and-hen-problem here,
but I am just not up for that call.</p>
</div>
</div>
<div class="sect3">
<h4 id="_maven_it_is"><a class="anchor" href="#_maven_it_is"></a>2.1.4. Maven it is</h4>
<div class="paragraph">
<p>Before I jump into how I configure my projects these days with Maven, just a quick recap:
The word Maven is a Yiddish word for "expert", derived from the Hebrew word mayvin (מבין), which means "who understands."
A maven is an expert who understands the skill or subject at hand:</p>
</div>
<div class="paragraph">
<p>Maven approaches a couple of things with "convention over configuration": It tries to tackle dependency management, the build process
and the deployment. It all evolves around a standard cycle of validate, compile, test, packaging, integration testing, installation and deploymenet.</p>
</div>
<div class="paragraph">
<p>One of the biggest critics here is having the "Project Object Model descriptor" - POM for short - materialized as <code>pom.xml</code>
doing both dependency management, build description and eventual being a representation of a deployed artifact.</p>
</div>
<div class="paragraph">
<p>I have decided that I can happily live with that.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Read the results from the Maven Dependencies Pop Quiz<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup> by
     <a href="https://twitter.com/aalmiray/">Andres Almiray</a>. Especially before you post stuff like this thing here to the internet.
     When in doubt, Andres is right.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_my_maven_best_practices"><a class="anchor" href="#_my_maven_best_practices"></a>2.2. My Maven best practices</h3>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Whatever you take away from this section, please consider <strong>always</strong> having the following properties defined:</p>
</div>
<div class="paragraph">
<p>First, specify the projects encoding with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="tag">&lt;/project.build.sourceEncoding&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>or with whatever you prefer. Otherwise, Maven - and Java - will default to the OS default encoding which is not always
what you expect so that your build is suddenly OS dependent.</p>
</div>
<div class="paragraph">
<p>Second, on Java versions prior to 11 and / or older versions of the Maven compiler plugin always define both</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;maven.compiler.source&gt;</span>1.8<span class="tag">&lt;/maven.compiler.source&gt;</span>
<span class="tag">&lt;maven.compiler.target&gt;</span>1.8<span class="tag">&lt;/maven.compiler.target&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With recent JDK versions and Maven compiler plugin you would define this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;maven.compiler.release&gt;</span>11<span class="tag">&lt;/maven.compiler.release&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example, you could safely use Java 17 and compile for 11 (or for 8): The system will guarantee that your source,
the generated bytecode <strong>and</strong> the API used are appropriate for the chosen target. Prior to that you might have created a library
that while being technically compatible with older versions but accidentally used newer API not available in older runtimes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_use_properties_and_dependency_management_for_versions"><a class="anchor" href="#_use_properties_and_dependency_management_for_versions"></a>2.2.1. Use properties and dependency management for versions</h4>
<div class="paragraph">
<p>Even in single-module project (Neo4j-Migrations is a multi-module project), I put every version of every dependency and every plugin I use
into a property in the <code>&lt;properties /&gt;</code> element.
For dependencies, I use the <code>&lt;dependencyManagement /&gt;</code> element.
The later might seem like overkill in a single module, but it will be a lifesaver when you encounter non-converging dependencies:
Those are dependencies that are transitive dependencies of your direct dependencies with mismatching versions: Your direct dependency
A depends on X:1, your direct dependency B on X:2.</p>
</div>
<div class="paragraph">
<p>When you declare a dependency on A before B, Maven will resolve X:1. When B is declared before A, it will resolve X:2. WHy?
Maven does build a graph of dependencies. For transitive dependencies, it will pick out the nearest dependency. That is, the
one that has the fewest number of hops from the direct dependency. This severely threatens the stability of your build.</p>
</div>
<div class="paragraph">
<p>Instead of excluding the transitive dependency from one direct dependency, you should use dependency management to exactly
specify which version you want (and from which you hope that is compatible with both direct dependencies).</p>
</div>
<div class="paragraph">
<p>The list of properties containing the versions helps me to keep an overview of what I have.
The dependency management allows me in submodules to omit the version altogether.
Have a look at my pom.xml, in the properties section<sup class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnotedef_5" title="View footnote.">5</a>]</sup> and the
dependency management<sup class="footnote">[<a id="_footnoteref_6" class="footnote" href="#_footnotedef_6" title="View footnote.">6</a>]</sup>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you don&#8217;t want to read all the following, you might consider having a look at the OSS Quickstart archetype <a href="#oss-quickstart">[oss-quickstart]</a>
from <a href="https://twitter.com/gunnarmorling">Gunnar Morling</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_make_use_of_the_enforcer_plugin"><a class="anchor" href="#_make_use_of_the_enforcer_plugin"></a>2.2.2. Make use of the enforcer plugin</h4>
<div class="paragraph">
<p>The self-titled "The Loving Iron Fist of Maven™", the <a href="#maven-enforcer-plugin">[maven-enforcer-plugin]</a>. It helps you to keep things straight.
I used it to</p>
</div>
<div class="ulist">
<ul>
<li>
<p>enforce the Java version required to build this project</p>
</li>
<li>
<p>the Maven version being used</p>
</li>
<li>
<p>that all dependencies converge</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See my configuration in <a href="#enforcer-plugin-config">Listing 1</a>.</p>
</div>
<div id="enforcer-plugin-config" class="listingblock">
<div class="title">Listing 1. My enforcer config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;plugin&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>maven-enforcer-plugin<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>${maven-enforcer-plugin.version}<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;executions&gt;</span>
        <span class="tag">&lt;execution&gt;</span>
            <span class="tag">&lt;id&gt;</span>enforce<span class="tag">&lt;/id&gt;</span>
            <span class="tag">&lt;goals&gt;</span>
                <span class="tag">&lt;goal&gt;</span>enforce<span class="tag">&lt;/goal&gt;</span>
            <span class="tag">&lt;/goals&gt;</span>
            <span class="tag">&lt;phase&gt;</span>validate<span class="tag">&lt;/phase&gt;</span>
            <span class="tag">&lt;configuration&gt;</span>
                <span class="tag">&lt;rules&gt;</span>
                    <span class="tag">&lt;requireJavaVersion&gt;</span>
                        <span class="tag">&lt;version&gt;</span>17<span class="tag">&lt;/version&gt;</span>
                    <span class="tag">&lt;/requireJavaVersion&gt;</span>
                    <span class="tag">&lt;DependencyConvergence</span> <span class="tag">/&gt;</span>
                    <span class="tag">&lt;requireMavenVersion&gt;</span>
                        <span class="tag">&lt;version&gt;</span>${maven.version}<span class="tag">&lt;/version&gt;</span>
                    <span class="tag">&lt;/requireMavenVersion&gt;</span>
                <span class="tag">&lt;/rules&gt;</span>
            <span class="tag">&lt;/configuration&gt;</span>
        <span class="tag">&lt;/execution&gt;</span>
    <span class="tag">&lt;/executions&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is so good, it brings tears to peoples faces<sup class="footnote">[<a id="_footnoteref_7" class="footnote" href="#_footnotedef_7" title="View footnote.">7</a>]</sup>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_more_conventions"><a class="anchor" href="#_more_conventions"></a>2.2.3. More conventions</h4>
<div class="paragraph">
<p>What is better than conventions? Well, more conventions<sup class="footnote">[<a id="_footnoteref_8" class="footnote" href="#_footnotedef_8" title="View footnote.">8</a>]</sup>.
The first one who brought the order of elements in a POM-file to attention was longtime Java User Group contributor and friend <a href="https://twitter.com/FrVaBe">Franz van Betteraey</a>.
The second one came from the Spring Boot team. I remember in one PR we discussed the order of dependencies.</p>
</div>
<div class="paragraph">
<p>All of that got me thinking: I don&#8217;t want to think too much, and just get it done. Ever since then, I add the "Sortpom Maven Plugin" <a href="#sortpom">[sortpom]</a> to new
projects like that:</p>
</div>
<div id="sortpom-config" class="listingblock">
<div class="title">Listing 2. Apply automatic sorting to pom files</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;plugin&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>com.github.ekryd.sortpom<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>sortpom-maven-plugin<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>${sortpom-maven-plugin.version}<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;configuration&gt;</span>
        <span class="tag">&lt;encoding&gt;</span>${project.build.sourceEncoding}<span class="tag">&lt;/encoding&gt;</span>
        <span class="tag">&lt;keepBlankLines&gt;</span>true<span class="tag">&lt;/keepBlankLines&gt;</span>
        <span class="tag">&lt;nrOfIndentSpace&gt;</span>-1<span class="tag">&lt;/nrOfIndentSpace&gt;</span>
        <span class="tag">&lt;sortProperties&gt;</span>true<span class="tag">&lt;/sortProperties&gt;</span>
        <span class="tag">&lt;sortDependencies&gt;</span>scope,groupId,artifactId<span class="tag">&lt;/sortDependencies&gt;</span>
        <span class="tag">&lt;createBackupFile&gt;</span>false<span class="tag">&lt;/createBackupFile&gt;</span>
        <span class="tag">&lt;expandEmptyElements&gt;</span>false<span class="tag">&lt;/expandEmptyElements&gt;</span>
    <span class="tag">&lt;/configuration&gt;</span>
    <span class="tag">&lt;executions&gt;</span>
        <span class="tag">&lt;execution&gt;</span>
            <span class="tag">&lt;goals&gt;</span>
                <span class="tag">&lt;goal&gt;</span>sort<span class="tag">&lt;/goal&gt;</span>
            <span class="tag">&lt;/goals&gt;</span>
            <span class="tag">&lt;phase&gt;</span>verify<span class="tag">&lt;/phase&gt;</span>
        <span class="tag">&lt;/execution&gt;</span>
    <span class="tag">&lt;/executions&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Either it automatically sorts the poms in the <code>verify</code> phase or call if independent: <code>./mvnw sortpom:verify@sort</code>.
It orders the elements of my pom in a stable, consistent order and also the dependencies, grouped by scope.
Remember what has been written about resolving transitive versions? When you just add a dependency on top of the dependency list,
it might have the same dependency as another direct dependency has below. Now suddenly the new transitive dependency will be
picked up. Sorting does not completely solve this problem, especially not without dependency management, but in many cases
results might be less surprising.</p>
</div>
</div>
<div class="sect3">
<h4 id="_escalate_away_from_conventions"><a class="anchor" href="#_escalate_away_from_conventions"></a>2.2.4. Escalate away from conventions</h4>
<div class="paragraph">
<p>The moment I would have to jump through so many loops to get a thing done via Maven configuration, I escalate in two steps.
Both are done via the Exec-Maven-Plugin <a href="#exec-maven-plugin">[exec-maven-plugin]</a>. The plugin is able to execute Java in the same JVM or alternatively,
external processes, either other programms or Java based calls. The latter can be configured to use the same class path
like the build.</p>
</div>
<div class="paragraph">
<p>So here are my 3 approaches to go from conventions to a programmatic approach: The farer away it get&#8217;s from Maven and convention,
the more issues might arise on "other peoples" machines:</p>
</div>
<div class="sect4">
<h5 id="_execute_a_java_program_with_your_current_classpath"><a class="anchor" href="#_execute_a_java_program_with_your_current_classpath"></a>Execute a Java program with your current classpath</h5>
<div class="paragraph">
<p>Maybe everything you need for a task is already inside your project. First step of escalating.
For the CLI module I use <a href="#picocli">[picocli]</a> and I added the <code>AutoComplete.GenerateCompletion</code> subcommand in <code>MigrationsCli</code> <sup class="footnote">[<a id="_footnoteref_9" class="footnote" href="#_footnotedef_9" title="View footnote.">9</a>]</sup>.
Thus, my CLI learned how to generate a shell completion script. There&#8217;s a lot about that topic in the "Autocomplete for Java Command Line Applications"<sup class="footnote">[<a id="_footnoteref_10" class="footnote" href="#_footnotedef_10" title="View footnote.">10</a>]</sup>
manual. I want to distribute the script as a resource, too. I don&#8217;t want to manually add it as a resource. Therefore, my build
should call the classes being build.
This is an excellent use case to for <a href="#exec-maven-plugin">[exec-maven-plugin]</a> calling Java with the current classpath as shown in <a href="#exec-maven-plugin-java-example">Listing 3</a>:</p>
</div>
<div id="exec-maven-plugin-java-example" class="listingblock">
<div class="title">Listing 3. Using Maven exec plugin to call single program (neo4j-migrations-cli/pom.xml)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;plugin&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.codehaus.mojo<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>exec-maven-plugin<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;executions&gt;</span>
        <span class="tag">&lt;execution&gt;</span>
            <span class="tag">&lt;id&gt;</span>generate-cli-completion<span class="tag">&lt;/id&gt;</span>
            <span class="tag">&lt;goals&gt;</span>
                <span class="tag">&lt;goal&gt;</span>exec<span class="tag">&lt;/goal&gt;</span>
            <span class="tag">&lt;/goals&gt;</span>
            <span class="tag">&lt;phase&gt;</span>package<span class="tag">&lt;/phase&gt;</span>
            <span class="tag">&lt;configuration</span> <span class="attribute-name">combine.self</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">override</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;executable&gt;</span>java<span class="tag">&lt;/executable&gt;</span>
                <span class="tag">&lt;arguments&gt;</span>
                    <span class="tag">&lt;argument&gt;</span>-classpath<span class="tag">&lt;/argument&gt;</span>
                    <span class="tag">&lt;classpath</span> <span class="tag">/&gt;</span>
                    <span class="tag">&lt;argument&gt;</span>${name-of-main-class}<span class="tag">&lt;/argument&gt;</span>
                    <span class="tag">&lt;argument&gt;</span>generate-completion<span class="tag">&lt;/argument&gt;</span>
                <span class="tag">&lt;/arguments&gt;</span>
                <span class="tag">&lt;outputFile&gt;</span>target/neo4j-migrations_completion<span class="tag">&lt;/outputFile&gt;</span>
            <span class="tag">&lt;/configuration&gt;</span>
        <span class="tag">&lt;/execution&gt;</span>
    <span class="tag">&lt;/executions&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Note that we can use the <code>&lt;classpath /&gt;</code> element here that passes the whole classpath to the <code>java</code> executable</p>
</li>
<li>
<p>Of course there is a property in the <code>pom.xml</code> holding the name of my main class, which is used in several places</p>
</li>
<li>
<p>The rest are a couple of args to the actual class being called</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_call_a_single_program"><a class="anchor" href="#_call_a_single_program"></a>Call a single program</h5>
<div class="paragraph">
<p>This is the next step of escalation. If I am just dealing with a single thing I need todo outside Maven or a plugin, I check
if it is a single call, simple to parameterize.
Compressing my GraalVM native binaries with UPX is such a thing as shown in <a href="#exec-maven-plugin-directly-example">Listing 4</a>:</p>
</div>
<div id="exec-maven-plugin-directly-example" class="listingblock">
<div class="title">Listing 4. Using Maven exec plugin to call s single program (neo4j-migrations-cli/pom.xml)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;plugin&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.codehaus.mojo<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>exec-maven-plugin<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;executions&gt;</span>
        <span class="tag">&lt;execution&gt;</span>
            <span class="tag">&lt;id&gt;</span>compress-binary<span class="tag">&lt;/id&gt;</span>
            <span class="tag">&lt;goals&gt;</span>
                <span class="tag">&lt;goal&gt;</span>exec<span class="tag">&lt;/goal&gt;</span>
            <span class="tag">&lt;/goals&gt;</span>
            <span class="tag">&lt;phase&gt;</span>package<span class="tag">&lt;/phase&gt;</span>
            <span class="tag">&lt;configuration</span> <span class="attribute-name">combine.self</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">override</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;executable&gt;</span>upx<span class="tag">&lt;/executable&gt;</span>
                <span class="tag">&lt;skip&gt;</span>${skipCompress}<span class="tag">&lt;/skip&gt;</span>
                <span class="tag">&lt;arguments&gt;</span>
                    <span class="tag">&lt;argument&gt;</span>${project.build.directory}/neo4j-migrations${executable-suffix}<span class="tag">&lt;/argument&gt;</span>
                <span class="tag">&lt;/arguments&gt;</span>
            <span class="tag">&lt;/configuration&gt;</span>
        <span class="tag">&lt;/execution&gt;</span>
    <span class="tag">&lt;/executions&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_scripting_things"><a class="anchor" href="#_scripting_things"></a>Scripting things</h5>
<div class="paragraph">
<p>If there is neither a class in my project solving my needs nor a single executable, I resort to scripting.
A <a href="#bash">[bash]</a> script seems reasonable these days, as bash or something compatible should be available in most places.
If you want to stick to what you most like have in your project, use a Java script with <a href="#JBang">[JBang]</a>.</p>
</div>
<div class="paragraph">
<p>I use <a href="#japicmd">[japicmd]</a> to compare previous and current versions of the project checking for semantic version or rather for changes
that would break semantic versioning. For this I need the current version number (given of course via the <code>&lt;version&gt;</code> tag)
and the previous version (given via a property named <code>neo4j-migrations.previous.version</code>).</p>
</div>
<div class="paragraph">
<p>The previous version number needs to be updated when a release has been prepared, just before the release plugin will commit
and tag the changes. I added a corresponding exec-maven configuration in the parent <code>pom.xml</code></p>
</div>
<div id="exec-maven-plugin-script-example" class="listingblock">
<div class="title">Listing 5. Using Maven exec plugin to call a script (pom.xml)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;plugin&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.codehaus.mojo<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>exec-maven-plugin<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>${exec-maven-plugin.version}<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;configuration&gt;</span>
        <span class="tag">&lt;skip&gt;</span>true<span class="tag">&lt;/skip&gt;</span>
    <span class="tag">&lt;/configuration&gt;</span>
    <span class="tag">&lt;executions&gt;</span>
        <span class="tag">&lt;execution&gt;</span>
            <span class="tag">&lt;id&gt;</span>release-prepared<span class="tag">&lt;/id&gt;</span>
            <span class="tag">&lt;goals&gt;</span>
                <span class="tag">&lt;goal&gt;</span>exec<span class="tag">&lt;/goal&gt;</span>
            <span class="tag">&lt;/goals&gt;</span>
            <span class="tag">&lt;configuration&gt;</span>
                <span class="tag">&lt;executable&gt;</span>bin/update-previous-version.sh<span class="tag">&lt;/executable&gt;</span>
                <span class="tag">&lt;skip&gt;</span>true<span class="tag">&lt;/skip&gt;</span>
            <span class="tag">&lt;/configuration&gt;</span>
        <span class="tag">&lt;/execution&gt;</span>
    <span class="tag">&lt;/executions&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You notice the execution has an identifier. It is referred in the release-plugin section:</p>
</div>
<div class="listingblock">
<div class="title">Listing 6. Calling a release completion goal (pom.xml)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;plugin&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>maven-release-plugin<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>${maven-release-plugin.version}<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;configuration&gt;</span>
        <span class="tag">&lt;autoVersionSubmodules&gt;</span>true<span class="tag">&lt;/autoVersionSubmodules&gt;</span>
        <span class="tag">&lt;useReleaseProfile&gt;</span>false<span class="tag">&lt;/useReleaseProfile&gt;</span>
        <span class="tag">&lt;releaseProfiles&gt;</span>release<span class="tag">&lt;/releaseProfiles&gt;</span>
        <span class="tag">&lt;tagNameFormat&gt;</span>@{project.version}<span class="tag">&lt;/tagNameFormat&gt;</span>
        <span class="tag">&lt;goals&gt;</span>deploy<span class="tag">&lt;/goals&gt;</span>
        <span class="tag">&lt;pushChanges&gt;</span>false<span class="tag">&lt;/pushChanges&gt;</span>
        <span class="tag">&lt;localCheckout&gt;</span>true<span class="tag">&lt;/localCheckout&gt;</span>
        <span class="tag">&lt;arguments&gt;</span>-Drelease -DisDryRun=${dryRun}<span class="tag">&lt;/arguments&gt;</span>
        <span class="tag">&lt;preparationGoals&gt;</span>clean exec:exec@prepare-release verify<span class="tag">&lt;/preparationGoals&gt;</span>
        <span class="tag">&lt;completionGoals&gt;</span>compile exec:exec@release-prepared<span class="tag">&lt;/completionGoals&gt;</span>
    <span class="tag">&lt;/configuration&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The script is rather simple (you&#8217;ll find it in the <a href="https://github.com/michael-simons/neo4j-migrations/tree/1.3.1/bin">bin</a> folder):</p>
</div>
<div class="listingblock">
<div class="title">Listing 7. Extracting a prepared version from Maven release files and updating a property (update-previous-version.sh)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">#!/usr/bin/env bash

set -euo pipefail
DIR=&quot;$(dirname &quot;$(realpath &quot;$0&quot;)&quot;)&quot;

NEW_OLD_VERSION=$(sed -n 's/project\.rel\.eu\.michael-simons\.neo4j\\:neo4j-migrations-parent=\(.*\)/\1/p' $DIR/../release.properties)
$DIR/../mvnw versions:set-property -DgenerateBackupPoms=false -Dproperty=neo4j-migrations.previous.version -DnewVersion=$NEW_OLD_VERSION -pl :neo4j-migrations-parent</code></pre>
</div>
</div>
<div class="paragraph">
<p>While a Maven maven would maybe have solved this with pure XML declaration, I couldn&#8217;t and would go as so far.
This is easier to read.</p>
</div>
<div class="paragraph">
<p>These days, you are not restricted to shell-scripts. You can just stick to Java if you want.
Have a look at my <a href="https://github.com/michael-simons/neo4j-migrations/blob/1.3.1/bin/test_native_cli.java">test_native_cli.java</a> script  in the same folder.
It is a Java program, orchestrating a <a href="#Testcontainer">[Testcontainer]</a> and testing the native build.
Right now, it is called from a GitHub action, but it would be easy enough to call it from Maven.
All the power of Java right at your hands, as a script via <a href="#JBang">[JBang]</a>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Frameworks"><a class="anchor" href="#Frameworks"></a>3. Frameworks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This part will speak about the "big" frameworks and what possibilities they offer and how you can hook up your library into them.
This is not about "low level" frameworks, such as a class scanning library, a command line tooling, but more outwards or up the stack.</p>
</div>
<div class="paragraph">
<p>I am talking about Spring Framework, Spring Boot, Quarkus, Helidon, Micronaut or similar. I will cover Spring Boot and Quarkus here
as those are the ones Neo4j-Migrations offers direct support for.</p>
</div>
<div class="sect2">
<h3 id="general-considerations"><a class="anchor" href="#general-considerations"></a>3.1. General considerations</h3>
<div class="paragraph">
<p>All the big frameworks come with a lot of dependencies already. If your library is written in such a way that it uses a ton
of dependencies as well, you or your users most likely end up in dependency issues pretty quickly. I honestly do think that the JDK offers
so many great APIs, being it for all the datastructures you need, sorting algorithms, String and general I/O operations and even
upto HTTP clients (just checkout out <code>java.net.http.HttpClient</code> for that matter), that there is often no good reason at all to add a heavyweight dependency to your project.</p>
</div>
<div class="paragraph">
<p>Things I have in mind here are <code>commons-lang</code>, <code>guava</code> and the like: First, look at what the JDK offers for a task at hand
or what is needed to create something decent yourself before you get yourself a couple of megabytes of dependencies.</p>
</div>
<div class="paragraph">
<p>On the other hand, specialized needs such as connecting to a database with a JDBC implementation or a specialized driver such
as in Neo4js case with the Bolt driver can&#8217;t be solved within a reasonable amount of work. The same applies to <a href="#ClassGraph">[ClassGraph]</a>
for example. ClassGraph is a library I use for scanning the class path for resources and for classes implementing a given interface.
I theoretically could do this all by myself but hardly as good (or as complete) as dedicated library.</p>
</div>
<div class="paragraph">
<p>However, you should never expose the API of such a library directly on your API. Why? Because if you do, you will be inevitably
glued to the evolution of a third party tool and that is probably not what you want if you like to follow semantic versioning or
things like that. Another reason: Sometimes such an API might not work in a target environment like one of the frameworks to follow,
and you might want to plug-in their solution for the same problem.</p>
</div>
<h4 id="_its_a_kind_of_magic" class="discrete">It&#8217;s a kind of magic!</h4>
<div class="paragraph">
<p>The above headline is not only the name of a great Queen song from 1986 accompanying the movie <em>Highlander</em> in which the same statement
is used to "explain" the immortals fighting for "the price", but it can also be used as a question. "Is this a kind of magic?":</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Is
@springboot
still considered as <strong>magic</strong> by anyone or has it already become a default and understood level of abstraction?</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Maciej Walkowiak<br>
<cite>https://twitter.com/maciejwalkowiak/status/1495528915535814660</cite>
</div>
</div>
<div class="paragraph">
<p>The discussion following was good and interesting. I have that approach in a talk for a while now. As a user of a car or
even of a computer itself: I don&#8217;t need to know how the single parts work or work together. To be honest, while I do know
the basic principle of how a combustion engine or an electric engine works, I couldn&#8217;t care less most of the time. There
are better trained specialists out there who can help me.</p>
</div>
<div class="paragraph">
<p>It gets more complicated when looking at computer: As a software engineer I better know the basic concepts of I/O, processor,
slow and fast memory and what have you. Should I be able to pick a computer apart and reassemble it? Does it make me a worse
software engineer when I never built my own PC? Should I even be aware how the electronics works? Questionable.</p>
</div>
<div class="paragraph">
<p>Things a are a bit different for a developer when looking at software: While some bootcamps are probably trying to cookie-cut
as many developers as possible and telling people that at least some computer science knowledge is overrated and frameworks
do all the heavy lifting, this is just not true. You should have a general ideas about complexity, memory usage, runtime behaviour
of algorithms and the like. And you can&#8217;t get around that you need to know in the end how a target framework of choice behaves.</p>
</div>
<div class="paragraph">
<p>I firmly believe understanding the mechanics of something like Spring Boot, Micronaut, Quarkus or even Helidon SE (which as a much more
visible and explicit "functional" approach) is paramount, for both a developer using such tech for creating applications and
business value as well as for developers wanting to contribute their thing to a framework.</p>
</div>
<div class="paragraph">
<p>So here we are, let&#8217;s break the magician&#8217;s code once again:</p>
</div>
</div>
<div class="sect2">
<h3 id="_spring_boot"><a class="anchor" href="#_spring_boot"></a>3.2. Spring Boot</h3>
<div class="paragraph">
<p>A lot has been said already about "the magic" about Spring Boot. Actually, I am one of the people who did start talking about it early on, see
<a href="#a-kind-of-magic-2016">[a-kind-of-magic-2016]</a>.
As this is known now by a lot of people and the concept of Spring Boot starter and their autoconfiguration is along now for more than 6 years
actually, I am going to refer to one of my talks from 2016 until the time being: "It&#8217;s a kind of magic? - Custom Spring Boot Starter"<sup class="footnote">[<a id="_footnoteref_11" class="footnote" href="#_footnotedef_11" title="View footnote.">11</a>]</sup></p>
</div>
</div>
<div class="sect2">
<h3 id="_quarkus"><a class="anchor" href="#_quarkus"></a>3.3. Quarkus</h3>
<div class="paragraph">
<p>Quarkus is a framework primarily developed by Red Hat. It is a Java framework tailored for deployment on Kubernetes.
Key technology components surrounding it are OpenJDK HotSpot and GraalVM. The goal of Quarkus is to make Java a leading
platform in Kubernetes and serverless environments while offering developers a unified reactive and imperative programming
model to optimally address a wider range of distributed application architectures. Its first version was published in March 2019.</p>
</div>
<div class="paragraph">
<p>It has a couple of design principles such as</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Container first</p>
</li>
<li>
<p>Developer productivity</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Wikipedia lists unifying imperative and reactive as well, but for the purpose of this chapter, the two above will do. Container first
with an emphasis on low memory usage and fast startup times go hand in hand with developer productivity:</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="https://xkcd.com/303/"><img src="https://imgs.xkcd.com/comics/compiling.png" alt="Obligatory XKCD (303)"></a>
</div>
</div>
<div class="paragraph">
<p>While I get back to speed of compiling, startup or restart in a moment, other things important for Quarkus are</p>
</div>
<div class="ulist">
<ul>
<li>
<p>unified configuration (Spring Boot has this of course too, and I personally like Springs configuration support better
than SmallRye&#8217;s one (SmallRye config is library use by Quarkus))</p>
</li>
<li>
<p>"Batteries included" approach: Quarkus uses <a href="#Testcontainer">[Testcontainer]</a> for bringing up any downstream service dependencies such as
databases, message brokers and the like. In case there is explicit configuration for such a service, the so called "Dev services"
will kick in and bring up a Neo4j database for you for example</p>
</li>
<li>
<p>Live coding: Quarkus undertakes some effort to determine whether classes or resources have changed when a request reaches
an application started in development mode. If so, that class is transparently recompiled and all parts of the application
affected will restart (that works actually much better than Spring Boots restart class loader)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The fast startup times, the unified configuration and the dev services are all relevant when you want to provide a Quarkus
extension for your library or service. These three points are a good chunk of why the Quarkus extension are designed the way they are.</p>
</div>
<div class="sect3">
<h4 id="_creating_a_closed_world_at_build_time"><a class="anchor" href="#_creating_a_closed_world_at_build_time"></a>3.3.1. Creating a closed world at build time</h4>
<div class="paragraph">
<p>The main "trick" inside Quarkus' sleeves is doing as much work and processing during build time to create a closed world.
Closed world meaning that "everything" (i.e. configuration, CDI beans, resources, entities and such) is known before the
startup of an application. That closed world is actually written to bytecode in many cases. Vice versa, stuff outside that
assumption for which can be guaranteed that there&#8217;s no execution path touching it, will not be loaded into a JVM.</p>
</div>
<div class="paragraph">
<p>All that goes together with avoiding reflection as much as possible. That would start by finding entities, JAX-RS resources,
over to (re)configuring things during runtime and wiring up collaborators (aka autowiring or injecting things) and many more
stuff we as developers using any framework with dependency injection take for granted.</p>
</div>
<div class="paragraph">
<p>If the assumption of a closed world sounds familiar: You might have heard in the context of the <a href="#GraalVM">[GraalVM]</a>. More specifically
together with its native image compilation: Turning a proper JVM program into a native machine binary. GraalVM itself removes any
unreachable code found within the application as well as any of its dependencies for the image to be as small as possible.
A native executable starts usually much faster and uses far less memory than a traditional JVM.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There are a couple of different approaches to that topic. <a href="#Micronaut">[Micronaut]</a> for examples goes "all in" in terms of annotation processing.
      Or - in the words of their architect Graeme Rocher - "Micronaut is an implementation of an annotation-based programming model."<sup class="footnote">[<a id="_footnoteref_12" class="footnote" href="#_footnotedef_12" title="View footnote.">12</a>]</sup>
      More specifically most if not all the annotations used in Micronaut applications are processed at compile time, not
      at runtime as other frameworks do. "The AnnotationMetadata API is a construct that is used both a compilation time and at runtime by
      framework components. AnnotationMetadata represents the computed fusion of annotation information for a particular type,
      field, constructor, method or bean property and may include both annotations declared in the source code, but also
      synthetic meta-annotations that can be used at runtime to implement framework logic."
     <br>
      I am pretty sure that Spring Framework 6 and the efforts undertaken at VMWare will move into a similar direction.
      I have written a small annotation processor<sup class="footnote">[<a id="_footnoteref_13" class="footnote" href="#_footnotedef_13" title="View footnote.">13</a>]</sup>
      for Neo4js <a href="#Cypher-DSL">[Cypher-DSL]</a> and the general Java Api for that is well-designed.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="build-steps"><a class="anchor" href="#build-steps"></a>Build steps</h5>
<div class="paragraph">
<p>Much of the following is taking straight from "Writing your own extension"<sup class="footnote">[<a id="_footnoteref_14" class="footnote" href="#_footnotedef_14" title="View footnote.">14</a>]</sup>,
a page probably not many casual users of Quarkus will ever open. It does however contain a lot of valuable resources. Most important
to understand the behaviour of your extension and an application eventually using it are the following three distinct phases of bootstrapping
a Quarkus app:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Augmentation</dt>
<dd>
<p>This initial phase is done via <em>Build Step Processors</em>, having access to an index containing annotations found
and ways of access to further descriptors, properties and <em>build items</em> created by previous processors. The outcome of those
build steps can have many forms: It ranges from additional resources put into the applications, hints which classes
to include in a GraalVM native image or (CDI) items available in your final application. Either way, the outcome is recorded into
actual bytecode. Furthermore, all build step processors can interact with <em>Recorders</em>. Those records are a way of blue printing
what should be eventually executed, so that it can be recorded into bytecode.</p>
<div class="paragraph">
<p>Bytecode recorded goes into <em>one</em> of the following phases:</p>
</div>
</dd>
<dt class="hdlist1">Static init</dt>
<dd>
<p>The framework is going to create a static method to be called from a main class that is going to initialize as
much of the application as possible.</p>
<div class="paragraph">
<p>The outcome of the static init phase can be recorded as is during augmentation / build time: Any library needed to produce it
can be dropped from the final class path so that it will never be loaded into the JVM running the application.</p>
</div>
<div class="paragraph">
<p>The static init is even more important for GraalVM native image: The static init is executed on a JVM during ahead-of-time
compilation and any objects retained there are directly serialized into the native executable. This means that if a framework
can boot in this phase then it will have its booted state directly written to the image. Of course this will be then executed
but the computation has already be done at this point.</p>
</div>
</dd>
<dt class="hdlist1">Runtime init</dt>
<dd>
<p>Steps recorded here are executed from an applications main method respectively during native executable boot.
There are no restrictions what can be done here. Ports and such can be opened.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>It is hopefully apparent that as much as possible should be pushed into static init to achieve the quickest startup possible.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_project_setup_for_an_extension"><a class="anchor" href="#_project_setup_for_an_extension"></a>3.3.2. Project setup for an extension</h4>
<div class="paragraph">
<p>Quarkus extensions are usually setup as multi-module projects containing the following modules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">neo4j-migrations-quarkus-parent
├── deployment
│   └── src
├── integration-tests
│   └── src
└── runtime
    └── src</code></pre>
</div>
</div>
<div class="paragraph">
<p>The parent project is usually responsible for dependency, plugin and build management, while the deployment module contains
all the necessary augmentation code and the runtime module the actual behaviour to be recorded. Integration tests are well,
integration tests.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Those are not your usual integration test! To test your extension the best way possible you will have eventually to
         create a real application like module and subject to augmentation. Just like a user would when using your extension.
         I found this to be one of the hardest thing to understand and learn.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The flow of dependencies is crucial to understand: A deployment module actually <em>must</em> depend on the runtime module as
the runtime module will contain the actual recorders and their dependencies. The reason: The recorded bytecode can of course
only be executed when it has access to the runtime classes. A runtime module on the other hand <em>must not</em> dependent on the
deployment module as that would pull in all Quarkus augmentation and deployment code into the runtime, quite the contrary of
what should be achieved.</p>
</div>
<div class="paragraph">
<p>On the other hand, deployment modules are of course allowed to depend on other deployment modules so that module <code>B</code> can consume
any build items from <code>A</code> and use them. The same applies for runtime modules: They are free to depend on other runtime modules.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The Quarkus people use Maven a lot. The make use of artifacts and extensions in a couple of places. Basically, using de-jure
or de-facto standards for getting you up to speed and running. You can use</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>mvn io.quarkus:quarkus-maven-plugin:create-extension \
  -DextensionId=my-ext \
  -Dname=&quot;My extension&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>to create a new extension. The process will ask you for a group id and depending on that, you will end up with a "standalone"
layout, the "Quarkiverse"<sup class="footnote">[<a id="_footnoteref_15" class="footnote" href="#_footnotedef_15" title="View footnote.">15</a>]</sup> layout (in case your group id starts with <code>io.quarkiverse.</code>)
or from within the Quarkus source tree itself, the "Quarkus core" layout.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_the_effect_on_neo4j_migrations"><a class="anchor" href="#_the_effect_on_neo4j_migrations"></a>3.3.3. The effect on Neo4j-Migrations</h4>
<div class="paragraph">
<p>How does the above restrictions respectively the philosophy affect Neo4j-Migrations and what can I enlist to demonstrate the
possibilities of a good deployment module? A couple of things, as it turns out:</p>
</div>
<div class="paragraph">
<p>First, Neo4j-Migrations depends on another deployment module, namely the Quarkus-Neo4j extension. How to access its primary
build item.</p>
</div>
<div class="paragraph">
<p>Neo4j-Migrations searches for resources (Cypher-Scripts) in both the class path as well as the file system. The latter is less
than a problem then the former: The file  system is of course always accessible (well, mostly always), regardless if things are
run on the JVM or native image. The class path is certainly accessible as well, but as we learned before, stuff that is not
accessed at build time or explicitly declared to be included in the image just won&#8217;t be there.</p>
</div>
<div class="paragraph">
<p>The same rules apply for Java (or Kotlin for that matter) implementations of <code>JavaBasedMigration</code> (an interface that allows for
programmatic migrations).</p>
</div>
<div class="paragraph">
<p>While resources and classes will always appear in the Quarkus JVM based output, they won&#8217;t appear in a GraalVM native image
without additional hints (compare <a href="#GraalVMTooling">the tooling available for creating native GraalVM images</a>). We are lucky,
Quarkus offers a couple of hints that will make sure that classes and resources are both read during startup and appear in a
native image.</p>
</div>
<div class="paragraph">
<p>Furthermore, I wanted to make sure that a <code>Migrations</code> instance is available as CDI bean, so that a user can access it and
call for <code>info</code>, <code>clean</code> and other operations.</p>
</div>
<div class="paragraph">
<p>And last but not least, can we add some decent information to the developer console? Let&#8217;s have a look at each of the above
points.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The relevant Quarkus code of Neo4j-Migrations is in this module and its submodules: <a href="https://github.com/michael-simons/neo4j-migrations/tree/1.4.0/neo4j-migrations-quarkus-parent">neo4j-migrations-quarkus-parent</a>,
     The main processor is of course in the deployment module <a href="https://github.com/michael-simons/neo4j-migrations/blob/6b6064c69d7429411e420895bafca8b4ac850fb2/neo4j-migrations-quarkus-parent/deployment/src/main/java/ac/simons/neo4j/migrations/quarkus/deployment/MigrationsProcessor.java#L65"><code>ac.simons.neo4j.migrations.quarkus.deployment.MigrationsProcessor</code></a>
     and the main recorder is <a href="https://github.com/michael-simons/neo4j-migrations/blob/6b6064c69d7429411e420895bafca8b4ac850fb2/neo4j-migrations-quarkus-parent/runtime/src/main/java/ac/simons/neo4j/migrations/quarkus/runtime/MigrationsRecorder.java#L39"><code>ac.simons.neo4j.migrations.quarkus.runtime.MigrationsRecorder</code>.</a>
    <br>
     <strong>Every</strong> method annotated with <code>@BuildStep</code> lives in a processor!
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_declaring_the_feature"><a class="anchor" href="#_declaring_the_feature"></a>Declaring the feature</h5>
<div class="paragraph">
<p>This is the easiest step of them all:</p>
</div>
<div id="createFeature" class="listingblock">
<div class="title">Listing 8. MigrationsProcessor#createFeature</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MigrationsProcessor</span> {

        <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> FEATURE_NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j-migrations</span><span class="delimiter">&quot;</span></span>;

        <span class="annotation">@BuildStep</span>
        <span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">unused</span><span class="delimiter">&quot;</span></span>)
        FeatureBuildItem createFeature() {

                <span class="keyword">return</span> <span class="keyword">new</span> FeatureBuildItem(FEATURE_NAME);
        }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is a <code>FeatureBuildItem</code> which just indicates a name for the feature provided by the extensions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
What&#8217;s with the <code>@SuppressWarnings("unused")</code>: That&#8217;s the downside of "magic" code: The <code>@BuildStep</code> gets invoked by
      the Maven plugins, so a static analyzer like Sonar (and most IDEs) have a hard time figuring out that this method is
      actually used. I spent enough time on the quadruple A-Rating in <a href="https://sonarcloud.io/summary/overall?id=eu.michael-simons.neo4j%3Aneo4j-migrations-parent">sonarcloud</a>
      which I don&#8217;t want to be spoiled with false positive of unused code.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_depending_on_another_deployment_module"><a class="anchor" href="#_depending_on_another_deployment_module"></a>Depending on another deployment module</h5>
<div class="paragraph">
<p>Neo4j-Migrations needs a connection to the Neo4j database it should be used with. This connection is provided via an instance
of Neo4js <code>Driver</code>. That driver comes from Quarkus Neo4j.
As the driver instance is of course a runtime dependency - it&#8217;s a bit hard to create a persistent database connection
during build time and then serialize it to byte code - we need to depend on the corresponding deployment module from our
own deployment module of course:</p>
</div>
<div id="quarkus-neo4j-deployment-dependency" class="listingblock">
<div class="title">Listing 9. pom.xml (in deployment)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>io.quarkiverse.neo4j<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>quarkus-neo4j-deployment<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And the for full measurement, the runtime dependency in the runtime module:</p>
</div>
<div id="quarkus-neo4j-dependency" class="listingblock">
<div class="title">Listing 10. pom.xml (in runtime)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>io.quarkiverse.neo4j<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>quarkus-neo4j<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, how to use it? We must step ahead to the build step that puts everything together. It looks like this:</p>
</div>
<div id="createMigrations" class="listingblock">
<div class="title">Listing 11. MigrationsProcessor#createMigrations</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@BuildStep</span>
<span class="annotation">@Record</span>(ExecutionTime.RUNTIME_INIT) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">unused</span><span class="delimiter">&quot;</span></span>)
MigrationsBuildItem createMigrations(
        MigrationsBuildTimeProperties buildTimeProperties,
        MigrationsProperties runtimeProperties,
        DiscovererBuildItem discovererBuildItem,
        ClasspathResourceScannerBuildItem classpathResourceScannerBuildItem,
        MigrationsRecorder migrationsRecorder,
        Neo4jDriverBuildItem driverBuildItem, <i class="conum" data-value="2"></i><b>(2)</b>
        BuildProducer&lt;SyntheticBeanBuildItem&gt; syntheticBeans
) {
        <span class="type">var</span> configRv = migrationsRecorder
                .recordConfig(
                        buildTimeProperties, runtimeProperties,
                        discovererBuildItem.getDiscoverer(),
                        classpathResourceScannerBuildItem.getScanner()
                );
        <span class="type">var</span> configBean = SyntheticBeanBuildItem
                .configure(MigrationsConfig.class)
                .runtimeValue(configRv).setRuntimeInit()
                .done();
        syntheticBeans.produce(configBean);

        <span class="type">var</span> migrationsRv = migrationsRecorder
                .recordMigrations(configRv, driverBuildItem.getValue()); <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="type">var</span> migrationsBean = SyntheticBeanBuildItem
                .configure(Migrations.class)
                .runtimeValue(migrationsRv)
                .setRuntimeInit()
                .done();
        syntheticBeans.produce(migrationsBean);

        <span class="keyword">return</span> <span class="keyword">new</span> MigrationsBuildItem(migrationsRv);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Remember what has been said in <a href="#build-steps">Section 3.3.1.1</a>? This annotation moves the bunch of code
eventually into runtime. The main reason here being the fact that we cannot longer postpone the access to a valid
physical database connection</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is a build item produced by a different extension. By declaring it as a method parameter, the build-plugins will
inject those items during build time for you</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Here we retrieve the value from the build item. Be aware, it&#8217;s return type is actually a <code>RuntimeValue&lt;Driver&gt;</code>.
The name is true to its nature: It is a value only accessible during runtime. It <strong>cannot</strong>  be used
here.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The usage of the runtime value of another extension must happen in a recorder in the runtime module.
<a href="#recordMigrations">Listing 12</a> shows the relevant piece of the recorder and actually the smallest one in terms of LoC: All the heavy lifting
has been done while creating the config:</p>
</div>
<div id="recordMigrations" class="listingblock">
<div class="title">Listing 12. MigrationsRecorder#recordMigrations</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Recorder</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MigrationsRecorder</span> {

        <span class="directive">public</span> RuntimeValue&lt;Migrations&gt; recordMigrations(
                RuntimeValue&lt;MigrationsConfig&gt; migrationsConfig,
                RuntimeValue&lt;<span class="predefined-type">Driver</span>&gt; driver
        ) {
                <span class="keyword">return</span> <span class="keyword">new</span> RuntimeValue&lt;&gt;(
                        <span class="keyword">new</span> Migrations(migrationsConfig.getValue(), driver.getValue()) <i class="conum" data-value="2"></i><b>(2)</b>
                );
        }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Marks the class as <code>@Recorder</code>. Any processor method annotated with <code>@Record(ExecutionTime.RUNTIME_INIT)</code> must declare
an argument being a recorder.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Both parameters passed to <code>recordMigrations</code> are runtime values. Only here (and actually, only when the byte code created with this method)
is executed, access to the runtime values value is possible.</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_properties_and_configuration"><a class="anchor" href="#_properties_and_configuration"></a>Properties and configuration</h5>
<div class="paragraph">
<p>To quote the Quarkus manual:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Some Quarkus configurations only take effect during build time, meaning is not possible to change them at runtime.
These configurations are still available at runtime but as read-only […].
A change to any of these configurations requires a rebuild of the application itself to reflect changes of such properties.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Which makes perfectly sense in terms of <a href="#build-steps">Section 3.3.1.1</a>: The more things are settled during build, the more things can be
written in <s>stone</s> bytecode.</p>
</div>
<div class="paragraph">
<p>So there 4 different configuration phases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>build time: Values are read and available for usage at build time.</p>
</li>
<li>
<p>build and runtime fixed: Values are read and available for usage at build time, and available on a read-only basis at run time.</p>
</li>
<li>
<p>bootstrap: Values are read and available for usage at run time and are re-read on each program execution.</p>
</li>
<li>
<p>run time: Values are read and available for usage at run time and are re-read on each program execution.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Phases that are relevant for Neo4j-Migrations are build and runtime fixed as well as runtime.
In therms of numbers, most options for Neo4j-Migrations are actually runtime options (compare the list <a href="https://michael-simons.github.io/neo4j-migrations/1.4.0/#usage_spring-boot_all-properties">here</a>),
such as the schema database or the target database (they might change depending on the URL (which is also runtime)) as well
as the name of the user who executed the migration and which user to impersonate. It&#8217;s just fair
to assume that when an application is connected to a different database, those change.</p>
</div>
<div class="paragraph">
<p>They go in a properties class annotated with <code>@ConfigRoot</code> indicating its phase as <code>ConfigPhase.RUN_TIME</code>:</p>
</div>
<div id="MigrationsProperties" class="listingblock">
<div class="title">Listing 13. MigrationsProperties (Excerpt)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ConfigRoot</span>(prefix = <span class="string"><span class="delimiter">&quot;</span><span class="content">org.neo4j</span><span class="delimiter">&quot;</span></span>, name = <span class="string"><span class="delimiter">&quot;</span><span class="content">migrations</span><span class="delimiter">&quot;</span></span>, phase = ConfigPhase.RUN_TIME)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MigrationsProperties</span> {

        <span class="annotation">@ConfigItem</span>
        <span class="directive">public</span> Optional&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt;&gt; externalLocations; <i class="conum" data-value="1"></i><b>(1)</b>

        <span class="annotation">@ConfigItem</span>
        <span class="directive">public</span> Optional&lt;<span class="predefined-type">String</span>&gt; database;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A way out of the build time properties later on.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Our build time properties is a lot smaller and the whole class fits in the book:</p>
</div>
<div id="MigrationsBuildTimeProperties" class="listingblock">
<div class="title">Listing 14. MigrationsBuildTimeProperties.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ConfigRoot</span>(prefix = <span class="string"><span class="delimiter">&quot;</span><span class="content">org.neo4j</span><span class="delimiter">&quot;</span></span>, name = <span class="string"><span class="delimiter">&quot;</span><span class="content">migrations</span><span class="delimiter">&quot;</span></span>, phase = ConfigPhase.BUILD_AND_RUN_TIME_FIXED)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MigrationsBuildTimeProperties</span> {

        <span class="annotation">@ConfigItem</span>
        <span class="directive">public</span> Optional&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt;&gt; packagesToScan;

        <span class="annotation">@ConfigItem</span>(defaultValue = Defaults.LOCATIONS_TO_SCAN_VALUE)
        <span class="directive">public</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; locationsToScan;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both these classes live in the runtime module and the only technical difference is the phase. In the <a href="#MigrationsBuildTimeProperties">Listing 14</a>
it is <code>ConfigPhase.BUILD_AND_RUN_TIME_FIXED</code>: The source of those properties is consulted during build time, passed to the system,
evaluated in a sensible way and eventually written to byte code.</p>
</div>
<div class="paragraph">
<p>And what should be pushed into build time? Discovering of classes and resources! Both of which Neo4j-Migrations
need to do its refactoring work.</p>
</div>
<div class="paragraph">
<p>Why the <code>externalLocations</code> property during runtime? This is an additional feature that allows to
configure filesystem only locations for those cases in which they aren&#8217;t any migrations to discover during build but
instead are stored completely independent of the application.</p>
</div>
<div class="paragraph">
<p>How to access these properties? They must be injected into <code>@BuildSteps</code>, <a href="#createMigrations">Listing 11</a> being one example. It receives
both build- and runtime properties. <a href="#createDiscoverer">Listing 15</a> is one more example coming up:</p>
</div>
</div>
<div class="sect4">
<h5 id="_discovering_and_registering_resources_and_classes_during_deployment"><a class="anchor" href="#_discovering_and_registering_resources_and_classes_during_deployment"></a>Discovering and registering resources and classes during deployment</h5>
<div class="paragraph">
<p>Quarkus uses <a href="#Jandex">[Jandex]</a> for discovering and indexing classes (of a given type, with certain annotations or listed in configuration files).
The documentation is a bit sparse around that topic, but Baeldung<sup class="footnote">[<a id="_footnoteref_16" class="footnote" href="#_footnotedef_16" title="View footnote.">16</a>]</sup> has you covered.
The index can be accessed through the core build items <code>BeanArchiveIndexBuildItem</code> and <code>CombinedIndexBuildItem</code>.
The latter allows programmatically adding classes to the index via a computing view on the index:
When a class is asked for by name, it will be added automatically.</p>
</div>
<div id="createDiscoverer" class="listingblock">
<div class="title">Listing 15. MigrationsProcessor#createDiscoverer</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@BuildStep</span>
<span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">unused</span><span class="delimiter">&quot;</span></span>)
DiscovererBuildItem createDiscoverer(
        CombinedIndexBuildItem combinedIndexBuildItem,
        MigrationsBuildTimeProperties buildTimeProperties
) {

        <span class="type">var</span> packagesToScan = buildTimeProperties.packagesToScan
                .orElseGet(<span class="predefined-type">List</span>::of);
        <span class="type">var</span> index = combinedIndexBuildItem.getIndex();
        <span class="type">var</span> classesFoundDuringBuild = findClassBasedMigrations(
                packagesToScan, index); <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="keyword">return</span> <span class="keyword">new</span> DiscovererBuildItem(StaticJavaBasedMigrationDiscoverer
                .of(classesFoundDuringBuild));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember what I said in <a href="#general-considerations">Section 3.1</a> about abstracting away any third-party API you might be using? This is the
part where it becomes relevant. While I do love <a href="#ClassGraph">[ClassGraph]</a>, it is not the perfect candidate for the task at hand: Discovering
resources and classes in a Quarkus build environment. While it worked in Quarkus 2.6, things broke in 2.7. Together <a href="https://twitter.com/lh">@lh</a>
I was able to fix this, but I was convinced to try Quarkus way.
In case you&#8217;re interested in the abstraction itself: It&#8217;s called <code>Discoverer&lt;JavaBasedMigration&gt;</code> and
it lives in <code>neo4j-migrations-core</code> inside the <code>neo4j-migrations-core</code> package. In most scenarios it uses the
ClassGraph implementation, in Quarkus it is a <code>StaticJavaBasedMigrationDiscoverer</code>
that is preloaded during build time with a fixed set of classes.</p>
</div>
<div class="paragraph">
<p>I spare you the gory details of <code>findClassBasedMigrations</code> and just pick the essential part:</p>
</div>
<div class="listingblock">
<div class="title">Listing 16. Asking the Jandex for all implementors of a given interface:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">var</span> dotName = DotName.createSimple(JavaBasedMigration.class.getName());
indexView
    .getAllKnownImplementors(dotName)
    .forEach(classInfo -&gt; {
        <span class="comment">// Do things with the classInfo found</span>
        <span class="comment">// For example loading it:</span>
        <span class="keyword">try</span> {
            <span class="predefined-type">Thread</span>.currentThread().getContextClassLoader()
                .loadClass(cf.name().toString())
                .asSubclass(JavaBasedMigration.class);
        } <span class="keyword">catch</span> (<span class="exception">ClassNotFoundException</span> e) {
            <span class="comment">// Whatever</span>
        }
    });</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you need access to class during build time, it must be loaded with the current threads classloader.
Now what to do with those classes? I first create a <code>DiscovererBuildItem</code> in <a href="#createMigrations">Listing 11</a>.
<code>DiscovererBuildItem</code> is a custom class, shown in the following listing:</p>
</div>
<div class="listingblock">
<div class="title">Listing 17. DiscovererBuildItem.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">final</span> <span class="type">class</span> <span class="class">DiscovererBuildItem</span> <span class="directive">extends</span> SimpleBuildItem {

        <span class="directive">private</span> <span class="directive">final</span> StaticJavaBasedMigrationDiscoverer discoverer;

        DiscovererBuildItem(StaticJavaBasedMigrationDiscoverer discoverer) {
                <span class="local-variable">this</span>.discoverer = discoverer;
        }

        StaticJavaBasedMigrationDiscoverer getDiscoverer() {
                <span class="keyword">return</span> discoverer;
        }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This build item can be passed along as needed. And it is needed indeed: It is not enough to tell Neo4j-Migrations core
"here are a set of classes", but these classes need to be registered for reflections as they are - most likely - never
called from application code and therefore removed.</p>
</div>
<div class="paragraph">
<p>A <code>ReflectiveClassBuildItem</code> to the rescue. This is a build in class that is used like this:</p>
</div>
<div id="registerMigrationsForReflections" class="listingblock">
<div class="title">Listing 18. MigrationsProcessor#registerMigrationsForReflections</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@BuildStep</span>
<span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">unused</span><span class="delimiter">&quot;</span></span>)
ReflectiveClassBuildItem registerMigrationsForReflections(DiscovererBuildItem discovererBuildItem) {

        <span class="type">var</span> classes = discovererBuildItem.getDiscoverer()
                .getMigrationClasses().toArray(<span class="keyword">new</span> <span class="predefined-type">Class</span>&lt;?&gt;[<span class="integer">0</span>]);
        <span class="keyword">return</span> <span class="keyword">new</span> ReflectiveClassBuildItem(<span class="predefined-constant">true</span>, <span class="predefined-constant">true</span>, <span class="predefined-constant">true</span>, classes);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The boolean parameters corresponds which parts are eligible for reflection (constructor, methods, fields).</p>
</div>
<div class="paragraph">
<p>Last but not least: Why are resources (like in Cypher-script files) also build time fixed? Because they must be explicitly
included in the native image when compiled via GraalVM, otherwise they are kept out. The abstraction of discovering is similar
to searching for classes, you can find it in the processor, too.</p>
</div>
<div class="paragraph">
<p>They key to have resources in the native image is the <code>NativeImageResourceBuildItem</code>:</p>
</div>
<div id="addCypherResources" class="listingblock">
<div class="title">Listing 19. MigrationsProcessor#addCypherResources</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@BuildStep</span>
<span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">unused</span><span class="delimiter">&quot;</span></span>)
NativeImageResourceBuildItem addCypherResources(
        ClasspathResourceScannerBuildItem classpathResourceScannerBuildItem
) {

        <span class="type">var</span> resources = classpathResourceScannerBuildItem.getScanner()
                .getResources();
        <span class="keyword">return</span> <span class="keyword">new</span> NativeImageResourceBuildItem(resources.stream()
                .map(ResourceWrapper::getPath)
                .collect(Collectors.toList()));
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Quarkus offers some ways to create additional resources during build. These most be added explicitly
     to native as well, this is not done automatically.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_adding_synthetic_beans"><a class="anchor" href="#_adding_synthetic_beans"></a>Adding synthetic beans</h5>
<div class="paragraph">
<p>As a final step, I wanted the user to be able to access the <code>Migrations</code> object in their (CDI) code and if enabled,
execute migrations as soon as the Quarkus application starts.</p>
</div>
<div class="paragraph">
<p>The former is done via a  <code>BuildProducer&lt;SyntheticBeanBuildItem&gt;</code> dependency, seen in <a href="#createMigrations">Listing 11</a>.
Such a producer is a way to return multiple (different) build items from a build step. Here, I add the configuration
and migrations bean as <code>SyntheticBeanBuildItem</code>.</p>
</div>
<div class="paragraph">
<p>Last but not least, things happening on startup is done via a <code>ServiceStartBuildItem</code>.
What is passed to a startup build item needs to be recorded in the build step producing the item as shown in <a href="#applyMigrations">Listing 20</a>:</p>
</div>
<div id="applyMigrations" class="listingblock">
<div class="title">Listing 20. MigrationsProcessor#applyMigrations</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@BuildStep</span>
<span class="annotation">@Record</span>(ExecutionTime.RUNTIME_INIT)
<span class="annotation">@SuppressWarnings</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">unused</span><span class="delimiter">&quot;</span></span>)
ServiceStartBuildItem applyMigrations(
        MigrationsProperties migrationsProperties,
        MigrationsRecorder migrationsRecorder,
        MigrationsBuildItem migrationsBuildItem
) {

        migrationsRecorder.applyMigrations(migrationsBuildItem.getValue(),
                migrationsRecorder.isEnabled(migrationsProperties));
        <span class="keyword">return</span> <span class="keyword">new</span> ServiceStartBuildItem(FEATURE_NAME);
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_contributing_to_the_developer_console"><a class="anchor" href="#_contributing_to_the_developer_console"></a>Contributing to the developer console</h5>
<div class="paragraph">
<p>I tried to cover what&#8217;s possible in a small video <a href="https://michael-simons.github.io/neo4j-migrations/current/#devservicesintegration">here</a>.
These things are usually done via an additional processor if they have some dynamic nature or just with "plain" <a href="https://quarkus.io/guides/qute">Qute template</a>.</p>
</div>
<div class="paragraph">
<p>In terms of dynamic features (like in our case, accessing the <code>Migrations</code> bean and calling methods on it), there&#8217;s an SPI for
that allowing to register VertX-HTTP based handlers.</p>
</div>
<div class="paragraph">
<p>In terms of build time and runtime behaviour they are similar to what has been discussed above, in terms of SPI I did read
some Quarkus source code.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_quintessence"><a class="anchor" href="#_quintessence"></a>3.3.4. Quintessence</h4>
<div class="paragraph">
<p>Without deep understanding how a framework - in this case Quarkus <strong>and</strong> the underlying target deployment of GraalVM native - works,
it is not really possible to integrate an like Neo4j-Migrations in an meaningful way.</p>
</div>
<div class="paragraph">
<p>But I&#8217;d go a step further: Without understanding the implications of deployment augmentation and runtime behaviour: The startup
time, the quick turnaround, it&#8217;s nice and shiny, but it&#8217;s too easy to miss on something when things go wrong.</p>
</div>
<div class="paragraph">
<p>My recommendation: For a "day 2" scenario, make sure what kind of target environment you have.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="releasing-things"><a class="anchor" href="#releasing-things"></a>4. Releasing things</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter, we will discuss such things as semantic versioning, indicating breaking changes early and of course, release tooling.</p>
</div>
<div class="sect2">
<h3 id="_semantic_versioning"><a class="anchor" href="#_semantic_versioning"></a>4.1. Semantic versioning</h3>

</div>
<div class="sect2">
<h3 id="_release_tooling"><a class="anchor" href="#_release_tooling"></a>4.2. Release tooling</h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources"><a class="anchor" href="#_resources"></a>Resources</h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a id="ASM"></a>[ASM] <a href="https://asm.ow2.io" class="bare">https://asm.ow2.io</a></p>
</li>
<li>
<p><a id="a-kind-of-magic-2016"></a>[a-kind-of-magic-2016] <a href="https://info.michael-simons.eu/2016/06/01/talking-about-custom-spring-boot-starter-at-spring-io/" class="bare">https://info.michael-simons.eu/2016/06/01/talking-about-custom-spring-boot-starter-at-spring-io/</a></p>
</li>
<li>
<p><a id="bash"></a>[bash] <a href="https://www.gnu.org/software/bash/" class="bare">https://www.gnu.org/software/bash/</a></p>
</li>
<li>
<p><a id="ClassGraph"></a>[ClassGraph] <a href="https://github.com/classgraph/classgraph" class="bare">https://github.com/classgraph/classgraph</a></p>
</li>
<li>
<p><a id="COCOMO"></a>[COCOMO] <a href="https://en.wikipedia.org/wiki/COCOMO" class="bare">https://en.wikipedia.org/wiki/COCOMO</a></p>
</li>
<li>
<p><a id="Cypher-DSL"></a>[Cypher-DSL] <a href="https://github.com/neo4j-contrib/cypher-dsl" class="bare">https://github.com/neo4j-contrib/cypher-dsl</a></p>
</li>
<li>
<p><a id="exec-maven-plugin"></a>[exec-maven-plugin] <a href="https://www.mojohaus.org/exec-maven-plugin" class="bare">https://www.mojohaus.org/exec-maven-plugin</a></p>
</li>
<li>
<p><a id="GraalVM"></a>[GraalVM] <a href="https://www.graalvm.org" class="bare">https://www.graalvm.org</a></p>
</li>
<li>
<p><a id="GraalVMTooling"></a>[GraalVMTooling] <a href="https://info.michael-simons.eu/2020/09/15/about-the-tooling-available-to-create-native-graalvm-images/" class="bare">https://info.michael-simons.eu/2020/09/15/about-the-tooling-available-to-create-native-graalvm-images/</a></p>
</li>
<li>
<p><a id="Helidon"></a>[Helidon] <a href="https://helidon.io" class="bare">https://helidon.io</a></p>
</li>
<li>
<p><a id="JBang"></a>[JBang] <a href="https://www.jbang.dev" class="bare">https://www.jbang.dev</a></p>
</li>
<li>
<p><a id="Jandex"></a>[Jandex] <a href="https://github.com/wildfly/jandex" class="bare">https://github.com/wildfly/jandex</a></p>
</li>
<li>
<p><a id="japicmd"></a>[japicmd] <a href="https://github.com/siom79/japicmp" class="bare">https://github.com/siom79/japicmp</a></p>
</li>
<li>
<p><a id="jep238"></a>[jep238] <a href="https://openjdk.java.net/jeps/238" class="bare">https://openjdk.java.net/jeps/238</a></p>
</li>
<li>
<p><a id="jep261"></a>[jep261] <a href="https://openjdk.java.net/jeps/261" class="bare">https://openjdk.java.net/jeps/261</a></p>
</li>
<li>
<p><a id="jep286"></a>[jep286] <a href="https://openjdk.java.net/jeps/286" class="bare">https://openjdk.java.net/jeps/286</a></p>
</li>
<li>
<p><a id="jep328"></a>[jep328] <a href="https://openjdk.java.net/jeps/328" class="bare">https://openjdk.java.net/jeps/328</a></p>
</li>
<li>
<p><a id="jep396"></a>[jep396] <a href="https://openjdk.java.net/jeps/396" class="bare">https://openjdk.java.net/jeps/396</a></p>
</li>
<li>
<p><a id="maven-enforcer-plugin"></a>[maven-enforcer-plugin] <a href="https://maven.apache.org/enforcer/maven-enforcer-plugin/" class="bare">https://maven.apache.org/enforcer/maven-enforcer-plugin/</a></p>
</li>
<li>
<p><a id="Micronaut"></a>[Micronaut] <a href="https://micronaut.io" class="bare">https://micronaut.io</a></p>
</li>
<li>
<p><a id="oss-quickstart"></a>[oss-quickstart] <a href="https://github.com/moditect/oss-quickstart" class="bare">https://github.com/moditect/oss-quickstart</a></p>
</li>
<li>
<p><a id="picocli"></a>[picocli] <a href="https://picocli.info" class="bare">https://picocli.info</a></p>
</li>
<li>
<p><a id="Quarkus"></a>[Quarkus] <a href="https://quarkus.io" class="bare">https://quarkus.io</a></p>
</li>
<li>
<p><a id="scc"></a>[scc] <a href="https://github.com/boyter/scc" class="bare">https://github.com/boyter/scc</a></p>
</li>
<li>
<p><a id="sortpom"></a>[sortpom] <a href="https://github.com/Ekryd/sortpom" class="bare">https://github.com/Ekryd/sortpom</a></p>
</li>
<li>
<p><a id="SpringBoot"></a>[SpringBoot] <a href="https://spring.io/projects/spring-boot" class="bare">https://spring.io/projects/spring-boot</a></p>
</li>
<li>
<p><a id="SpringFramework"></a>[SpringFramework] <a href="https://spring.io/projects/spring-framework" class="bare">https://spring.io/projects/spring-framework</a></p>
</li>
<li>
<p><a id="stein-maven-coordinates-and-module-names"></a>[stein-maven-coordinates-and-module-names] <a href="https://sormuras.github.io/blog/2019-08-04-maven-coordinates-and-java-module-names.html" class="bare">https://sormuras.github.io/blog/2019-08-04-maven-coordinates-and-java-module-names.html</a></p>
</li>
<li>
<p><a id="Testcontainer"></a>[Testcontainer] <a href="https://www.testcontainers.org" class="bare">https://www.testcontainers.org</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. <a href="https://spring.io/blog/2021/12/16/spring-framework-6-0-m1-released" class="bare">https://spring.io/blog/2021/12/16/spring-framework-6-0-m1-released</a>
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. <a href="https://docs.oracle.com/en/java/javase/17/docs/specs/man/javac.html" class="bare">https://docs.oracle.com/en/java/javase/17/docs/specs/man/javac.html</a>
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. <a href="https://spring.io/blog/2020/06/08/migrating-spring-boot-s-build-to-gradle" class="bare">https://spring.io/blog/2020/06/08/migrating-spring-boot-s-build-to-gradle</a>
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. <a href="https://andresalmiray.com/maven-dependencies-pop-quiz-results/" class="bare">https://andresalmiray.com/maven-dependencies-pop-quiz-results/</a>
</div>
<div class="footnote" id="_footnotedef_5">
<a href="#_footnoteref_5">5</a>. <a href="https://github.com/michael-simons/neo4j-migrations/blob/662018028e1ffc89bf4558eed23a463fe11e2ccf/pom.xml#L66" class="bare">https://github.com/michael-simons/neo4j-migrations/blob/662018028e1ffc89bf4558eed23a463fe11e2ccf/pom.xml#L66</a>
</div>
<div class="footnote" id="_footnotedef_6">
<a href="#_footnoteref_6">6</a>. <a href="https://github.com/michael-simons/neo4j-migrations/blob/662018028e1ffc89bf4558eed23a463fe11e2ccf/pom.xml#L135" class="bare">https://github.com/michael-simons/neo4j-migrations/blob/662018028e1ffc89bf4558eed23a463fe11e2ccf/pom.xml#L135</a>
</div>
<div class="footnote" id="_footnotedef_7">
<a href="#_footnoteref_7">7</a>. <a href="https://twitter.com/aalmiray/status/1478036541238923267" class="bare">https://twitter.com/aalmiray/status/1478036541238923267</a>
</div>
<div class="footnote" id="_footnotedef_8">
<a href="#_footnoteref_8">8</a>. <a href="https://maven.apache.org/developers/conventions/code.html" class="bare">https://maven.apache.org/developers/conventions/code.html</a>
</div>
<div class="footnote" id="_footnotedef_9">
<a href="#_footnoteref_9">9</a>. <a href="https://github.com/michael-simons/neo4j-migrations/blob/662018028e1ffc89bf4558eed23a463fe11e2ccf/neo4j-migrations-cli/src/main/java/ac/simons/neo4j/migrations/cli/MigrationsCli.java#L62" class="bare">https://github.com/michael-simons/neo4j-migrations/blob/662018028e1ffc89bf4558eed23a463fe11e2ccf/neo4j-migrations-cli/src/main/java/ac/simons/neo4j/migrations/cli/MigrationsCli.java#L62</a>
</div>
<div class="footnote" id="_footnotedef_10">
<a href="#_footnoteref_10">10</a>. <a href="https://picocli.info/autocomplete.html" class="bare">https://picocli.info/autocomplete.html</a>
</div>
<div class="footnote" id="_footnotedef_11">
<a href="#_footnoteref_11">11</a>. <a href="https://speakerdeck.com/michaelsimons/its-a-kind-of-magic-custom-spring-boot-starter" class="bare">https://speakerdeck.com/michaelsimons/its-a-kind-of-magic-custom-spring-boot-starter</a>
</div>
<div class="footnote" id="_footnotedef_12">
<a href="#_footnoteref_12">12</a>. <a href="https://docs.micronaut.io/latest/guide/index.html#architecture" class="bare">https://docs.micronaut.io/latest/guide/index.html#architecture</a>
</div>
<div class="footnote" id="_footnotedef_13">
<a href="#_footnoteref_13">13</a>. <a href="https://github.com/neo4j-contrib/cypher-dsl/tree/main/neo4j-cypher-dsl-codegen/neo4j-cypher-dsl-codegen-sdn6" class="bare">https://github.com/neo4j-contrib/cypher-dsl/tree/main/neo4j-cypher-dsl-codegen/neo4j-cypher-dsl-codegen-sdn6</a>
</div>
<div class="footnote" id="_footnotedef_14">
<a href="#_footnoteref_14">14</a>. <a href="https://quarkus.io/guides/writing-extensions#bootstrap-three-phases" class="bare">https://quarkus.io/guides/writing-extensions#bootstrap-three-phases</a>
</div>
<div class="footnote" id="_footnotedef_15">
<a href="#_footnoteref_15">15</a>. <a href="https://github.com/quarkiverse" class="bare">https://github.com/quarkiverse</a>
</div>
<div class="footnote" id="_footnotedef_16">
<a href="#_footnoteref_16">16</a>. <a href="https://www.baeldung.com/quarkus-bean-discovery-index" class="bare">https://www.baeldung.com/quarkus-bean-discovery-index</a>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-03-07 09:29:44 +0100
</div>
</div>
</body>
</html>